name: Operations Smoke Test

on:
  push:
    branches: [ main, feature/** ]
    paths:
      - 'packages/afo-core/**'
      - 'packages/dashboard/**'
      - 'docker-compose.yml'
      - 'compose.yml'
      - '.env.afo'
  workflow_dispatch:
  pull_request:
    branches: [ main, feature/** ]
    paths:
      - 'packages/afo-core/**'
      - 'packages/dashboard/**'
      - 'docker-compose.yml'
      - 'compose.yml'
      - '.env.afo'

jobs:
  smoke-test:
    runs-on: ubuntu-latest

    env:
      AFO_BASE_URL: http://localhost:8010

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Locate Compose file
      id: compose
      shell: bash
      run: |
        set -euo pipefail
        for f in \
          docker-compose.yml docker-compose.yaml compose.yml compose.yaml \
          packages/afo-core/docker-compose.yml packages/afo-core/docker-compose.yaml \
          packages/afo-core/compose.yml packages/afo-core/compose.yaml
        do
          if [ -f "$f" ]; then
            echo "file=$f" >> "$GITHUB_OUTPUT"
            echo "[info] compose file: $f"
            exit 0
          fi
        done
        echo "::error::compose file not found"
        exit 1

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build services
      run: |
        export COMPOSE_FILE="${{ steps.compose.outputs.file }}"

        # Build services sequentially to avoid race conditions
        if command -v docker-compose >/dev/null 2>&1; then
          docker-compose build
        else
          docker compose build
        fi

    - name: Set up Docker
      run: |
        # Start Docker daemon
        sudo systemctl start docker

        # Wait for Docker to be ready
        timeout 60 bash -c 'until docker info >/dev/null 2>&1; do sleep 1; done'

    - name: Create .env.afo from secrets
      run: |
        echo "AFO_INTERNAL_SECRET=${{ secrets.AFO_INTERNAL_SECRET }}" > .env.afo
        chmod 600 .env.afo

    - name: Start services with Docker Compose
      run: |
        # Try docker-compose first, then docker compose
        if command -v docker-compose >/dev/null 2>&1; then
          COMPOSE_CMD="docker-compose"
        else
          COMPOSE_CMD="docker compose"
        fi

        # Clean up disk space before build
        echo "Cleaning up disk space..."
        df -h
        docker system prune -f
        rm -rf /tmp/* || true

        # Start services in background (Bake already built with cache, just run)
        COMPOSE_FILE="${{ steps.compose.outputs.file }}"
        $COMPOSE_CMD -f "$COMPOSE_FILE" up -d --no-build

        # Wait for services to be ready (max 120 seconds)
        echo "Waiting for services to start..."
        for i in {1..120}; do
          if curl -s http://localhost:8010/api/health >/dev/null 2>&1 && \
             curl -s http://localhost:8001/health >/dev/null 2>&1 && \
             curl -s http://localhost:3000/ >/dev/null 2>&1; then
            echo "Services are ready after ${i}s"
            break
          fi
          if [[ $i -eq 120 ]]; then
            echo "Services failed to start within 120 seconds"
            $COMPOSE_CMD -f "$COMPOSE_FILE" logs
            exit 1
          fi
          sleep 1
        done

    - name: Run Operations Smoke Test
      env:
        AFO_INTERNAL_SECRET: test_secret_2025
      run: |
        # Make script executable and run
        chmod +x scripts/ops_smoke.sh
        ./scripts/ops_smoke.sh

    - name: Warm up /health (register + set trinity metric)
      run: |
        set -euo pipefail
        echo "[info] warming up: ${{ env.AFO_BASE_URL }}/health"
        curl -sf \
          --retry 30 \
          --retry-connrefused \
          --retry-delay 1 \
          "${{ env.AFO_BASE_URL }}/health" >/dev/null

    - name: Trinity Metrics Consistency Gate
      run: |
        echo "ðŸ° Trinity Metrics Consistency ê²€ì¦"
        chmod +x scripts/ci/check_trinity_metrics.sh
        ./scripts/ci/check_trinity_metrics.sh
      env:
        AFO_TRINITY_METRIC_NAME: afo_trinity_score_total
        TRINITY_EPSILON: "0.0001"
        # ë©”ì¸ ë¸Œëžœì¹˜ì—ì„œë§Œ ì—„ê²© ëª¨ë“œ (ë©”íŠ¸ë¦­ ì—†ìœ¼ë©´ FAIL)
        # feature ë¸Œëžœì¹˜ëŠ” ê²½ê³ ë§Œ (ê°œë°œ íŽ¸ì˜ì„±)
        AFO_REQUIRE_TRINITY_METRIC: ${{ github.ref == 'refs/heads/main' && '1' || '0' }}

    - name: Trivy (gate: HIGH/CRITICAL)
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: fs
        scan-ref: .
        trivy-config: trivy.yaml
        severity: CRITICAL,HIGH
        exit-code: "1"
        ignore-unfixed: true
        cache: true

    - name: Trivy (sarif report)
      if: always()
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: fs
        scan-ref: .
        trivy-config: trivy.yaml
        format: sarif
        output: trivy-results.sarif
        exit-code: "0"
        severity: CRITICAL,HIGH,MEDIUM
        limit-severities-for-sarif: true
        cache: true

    - name: Upload Trivy SARIF
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-results.sarif

    - name: Debug dump /health (only if failed)
      if: ${{ failure() }}
      run: |
        echo "[debug] /health (failure debug):"
        curl -s "${{ env.AFO_BASE_URL }}/health" | head -c 2000 || echo "[error] curl failed"

    - name: Debug dump /metrics (only if failed)
      if: ${{ failure() }}
      run: |
        echo "[debug] /metrics head (failure debug):"
        curl -sf "${{ env.AFO_BASE_URL }}/metrics" | head -n 120 || echo "[error] curl failed"

    - name: Debug dump docker logs (only if failed)
      if: ${{ failure() }}
      run: |
        echo "[debug] docker-compose ps:"
        docker compose -f packages/afo-core/docker-compose.yml ps || true
        echo "[debug] docker-compose logs (tail):"
        docker compose -f "${{ steps.compose.outputs.file }}" logs --tail=300 || true
    - name: Show service logs on failure
      if: failure()
      run: |
        echo "=== Service Logs ==="
        if command -v docker-compose >/dev/null 2>&1; then
          docker-compose -f "${{ steps.compose.outputs.file }}" logs --tail=50
        else
          docker compose -f "${{ steps.compose.outputs.file }}" logs --tail=50
        fi

    - name: Cleanup
      if: always()
      run: |
        echo "=== Cleanup ==="
        if command -v docker-compose >/dev/null 2>&1; then
          docker-compose -f "${{ steps.compose.outputs.file }}" down -v --remove-orphans || true
        else
          docker compose -f "${{ steps.compose.outputs.file }}" down -v --remove-orphans || true
        fi