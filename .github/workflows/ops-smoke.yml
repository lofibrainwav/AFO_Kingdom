name: Operations Smoke Test

on:
  push:
    branches: [ main, feature/** ]
    paths:
      - 'packages/afo-core/**'
      - 'packages/dashboard/**'
      - 'docker-compose.yml'
      - 'compose.yml'
      - '.env.afo'
  pull_request:
    branches: [ main, feature/** ]
    paths:
      - 'packages/afo-core/**'
      - 'packages/dashboard/**'
      - 'docker-compose.yml'
      - 'compose.yml'
      - '.env.afo'

jobs:
  smoke-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker
      run: |
        # Start Docker daemon
        sudo systemctl start docker

        # Wait for Docker to be ready
        timeout 60 bash -c 'until docker info >/dev/null 2>&1; do sleep 1; done'

    - name: Create .env.afo from secrets
      run: |
        echo "AFO_INTERNAL_SECRET=${{ secrets.AFO_INTERNAL_SECRET }}" > .env.afo
        chmod 600 .env.afo

    - name: Start services with Docker Compose
      run: |
        # Try docker-compose first, then docker compose
        if command -v docker-compose >/dev/null 2>&1; then
          COMPOSE_CMD="docker-compose"
        else
          COMPOSE_CMD="docker compose"
        fi

        # Start services in background
        $COMPOSE_CMD up -d --build

        # Wait for services to be ready (max 120 seconds)
        echo "Waiting for services to start..."
        for i in {1..120}; do
          if curl -s http://localhost:8010/api/health >/dev/null 2>&1 && \
             curl -s http://localhost:8001/health >/dev/null 2>&1 && \
             curl -s http://localhost:3000/ >/dev/null 2>&1; then
            echo "Services are ready after ${i}s"
            break
          fi
          if [[ $i -eq 120 ]]; then
            echo "Services failed to start within 120 seconds"
            $COMPOSE_CMD logs
            exit 1
          fi
          sleep 1
        done

    - name: Run Operations Smoke Test
      env:
        AFO_INTERNAL_SECRET: test_secret_2025
      run: |
        # Make script executable and run
        chmod +x scripts/ops_smoke.sh
        ./scripts/ops_smoke.sh

    - name: Warm up /health (register + set trinity metric)
      run: |
        curl -sf http://localhost:8010/health >/dev/null

    - name: Trinity Metrics Consistency Gate
      run: |
        echo "ðŸ° Trinity Metrics Consistency ê²€ì¦"
        chmod +x scripts/ci/check_trinity_metrics.sh
        ./scripts/ci/check_trinity_metrics.sh
      env:
        AFO_BASE_URL: http://localhost:8010
        AFO_TRINITY_METRIC_NAME: afo_trinity_score_total
        TRINITY_EPSILON: "0.0001"
        # ë©”íŠ¸ë¦­ì´ ì•„ì§ /metricsì— ì•ˆ ëœ¨ëŠ” í™˜ê²½ì´ë©´ 0 ìœ ì§€(ê²½ê³  í›„ PASS ê°€ëŠ¥)
        # /metrics ë…¸ì¶œì´ ë³´ìž¥ë˜ë©´ 1ë¡œ ì˜¬ë ¤ì„œ "ì—†ìœ¼ë©´ FAIL"ë¡œ ê°•ì œ
        AFO_REQUIRE_TRINITY_METRIC: "0"
    - name: Show service logs on failure
      if: failure()
      run: |
        echo "=== Service Logs ==="
        if command -v docker-compose >/dev/null 2>&1; then
          docker-compose logs --tail=50
        else
          docker compose logs --tail=50
        fi

    - name: Cleanup
      if: always()
      run: |
        echo "=== Cleanup ==="
        if command -v docker-compose >/dev/null 2>&1; then
          docker-compose down -v --remove-orphans || true
        else
          docker compose down -v --remove-orphans || true
        fi