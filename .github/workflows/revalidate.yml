name: Revalidate fragments (dynamic)

on:
  push:
    branches: [main]
    paths:
      - "fragments/**"
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: revalidate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  revalidate:
    runs-on: ubuntu-latest

    env:
      REVALIDATE_URL: ${{ vars.REVALIDATE_URL }}
      MAX_KEYS: "25"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Guard - required secret/url
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${{ secrets.REVALIDATE_SECRET }}" ]]; then
            echo "Missing secrets.REVALIDATE_SECRET" >&2
            exit 1
          fi
          if [[ -z "${REVALIDATE_URL}" ]]; then
            echo "Missing vars.REVALIDATE_URL (e.g., https://<domain>/api/revalidate)" >&2
            exit 1
          fi
          # Trailing slash 제거 (308 리다이렉트/차단 방지)
          REVALIDATE_URL="${REVALIDATE_URL%/}"
          echo "REVALIDATE_URL=${REVALIDATE_URL}" >> "$GITHUB_ENV"

      - name: Detect changed fragment keys
        id: detect
        shell: bash
        run: |
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          # 첫 푸시/예외 케이스 대비
          if [[ -z "$BEFORE" || "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
            BEFORE="HEAD~1"
            AFTER="HEAD"
          fi

          CHANGED="$(git diff --name-only "$BEFORE" "$AFTER" || true)"
          KEYS=""

          while IFS= read -r f; do
            [[ -z "$f" ]] && continue
            [[ "$f" != fragments/* ]] && continue
            [[ "$f" != *.html ]] && continue

            key="$(basename "$f" .html)"

            # fragmentKey와 동일한 정규식 (Commit 1과 일치)
            if [[ ! "$key" =~ ^[A-Za-z0-9][A-Za-z0-9_-]{0,127}$ ]]; then
              echo "Skip invalid key derived from file: $f" >&2
              continue
            fi

            KEYS="$KEYS $key"
          done <<< "$CHANGED"

          # 상한 적용
          COUNT=0
          OUT=""
          for k in $KEYS; do
            COUNT=$((COUNT+1))
            if [[ "$COUNT" -le "${MAX_KEYS}" ]]; then
              OUT="$OUT $k"
            fi
          done

          # 선행 공백 제거 후 outputs에 추가
          if [[ -n "$OUT" ]]; then
            OUT="${OUT# }"
            echo "keys=$OUT" >> "$GITHUB_OUTPUT"
          else
            echo "keys=" >> "$GITHUB_OUTPUT"
          fi

      - name: Call revalidate API
        if: steps.detect.outputs.keys != ''
        shell: bash
        run: |
          echo "Revalidating keys:${{ steps.detect.outputs.keys }}"
          for key in ${{ steps.detect.outputs.keys }}; do
            payload='{"fragmentKey":"'"$key"'"}'
            curl --fail-with-body -sS -X POST "${REVALIDATE_URL}" \
              -H "x-revalidate-secret: ${{ secrets.REVALIDATE_SECRET }}" \
              -H "content-type: application/json" \
              -d "${payload}"
            echo ""
          done

      - name: No-op (no fragment changes)
        if: steps.detect.outputs.keys == ''
        run: echo "No fragment changes detected; skipping."

