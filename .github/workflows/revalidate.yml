# ============================================================================
# AFO Kingdom Edge Revalidation Workflow (ÏïÑÎ¶ÑÎã§Ïö¥ ÏΩîÎìú Ï†ÅÏö©)
# ============================================================================
#
# Trinity Score Í∏∞Î∞ò ÏïÑÎ¶ÑÎã§Ïö¥ ÏΩîÎìúÎ°ú Íµ¨ÌòÑÎêú Ïó£ÏßÄ Î¶¨Î≤®Î¶¨Îç∞Ïù¥ÏÖò CI/CD ÏõåÌÅ¨ÌîåÎ°úÏö∞
#
# Author: AFO Kingdom Development Team
# Date: 2025-12-24
# Version: 2.0.0 (Beautiful Code Edition)
#
# Philosophy:
# - Êô∫ (Wisdom): Ï†ÑÎûµÏ†Å Î∞∞Ìè¨ÏôÄ Î°§Î∞± Í¥ÄÎ¶¨
# - Áúû (Truth): Ï†ïÌôïÌïú ÌôòÍ≤ΩÎ≥Ñ ÏÑ§Ï†ïÍ≥º Í≤ÄÏ¶ù
# - Áæé (Beauty): ÍπîÎÅîÌïòÍ≥† ÏùΩÍ∏∞ Ïâ¨Ïö¥ ÏõåÌÅ¨ÌîåÎ°úÏö∞ Íµ¨Ï°∞
# - Â≠ù (Serenity): ÏïàÏ†ïÏ†ÅÏù∏ Î∞∞Ìè¨ÏôÄ Î™®ÎãàÌÑ∞ÎßÅ
# - Ê∞∏ (Eternity): ÏßÄÏÜç Í∞ÄÎä•Ìïú CI/CD ÌååÏù¥ÌîÑÎùºÏù∏
#
# ============================================================================

# ----------------------------------------------------------------------------
# ÏõåÌÅ¨ÌîåÎ°úÏö∞ Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ (Trinity Score: Áæé - Ï≤¥Í≥ÑÏ†Å Íµ¨Ï°∞Ìôî)
# ----------------------------------------------------------------------------
name: 'üéØ AFO Edge Revalidation (Beautiful CI/CD)'

# ----------------------------------------------------------------------------
# Ìä∏Î¶¨Í±∞ ÏÑ§Ï†ï (Trinity Score: ÂñÑ - Î≥¥ÏïàÍ≥º Ïú†Ïó∞ÏÑ± Í∑†Ìòï)
# ----------------------------------------------------------------------------
on:
  # ÏàòÎèô Ìä∏Î¶¨Í±∞ (Î≥¥Ïïà Í≤åÏù¥Ìä∏)
  workflow_dispatch:
    inputs:
      environment:
        description: 'üéØ ÎåÄÏÉÅ ÌôòÍ≤Ω ÏÑ†ÌÉù (Target Environment)'
        required: true
        default: 'development'
        type: choice
        options:
          - development  # Í∞úÎ∞ú ÌôòÍ≤Ω
          - staging     # Ïä§ÌÖåÏù¥Ïßï ÌôòÍ≤Ω
          - production  # ÌîÑÎ°úÎçïÏÖò ÌôòÍ≤Ω
      fragment_key:
        description: 'üîë Î¶¨Î≤®Î¶¨Îç∞Ïù¥ÏÖòÌï† ÌîÑÎûòÍ∑∏Î®ºÌä∏ ÌÇ§ (Fragment Key to Revalidate)'
        required: true
        default: 'trinity_evidence'
        type: string
        # ÏòàÏãú: trinity_evidence, status, dashboard, api_metrics

jobs:
  revalidate:
    runs-on: ubuntu-latest
    steps:
      - name: Determine Target URL
        id: target
        run: |
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            echo "URL=${{ secrets.DASHBOARD_URL_PROD }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.environment }}" == "staging" ]; then
            echo "URL=${{ secrets.DASHBOARD_URL_STAGING }}" >> $GITHUB_OUTPUT
          else
            echo "URL=${{ secrets.DASHBOARD_URL_DEV }}" >> $GITHUB_OUTPUT
          fi

      - name: Execute Revalidation
        run: |
          echo "üöÄ Revalidating ${{ github.event.inputs.fragment_key }} on ${{ github.event.inputs.environment }}..."
          
          # Default to localhost:3000 if secret is missing (for local act testing or misconfig)
          TARGET_URL=${{ steps.target.outputs.URL }}
          if [ -z "$TARGET_URL" ]; then
            echo "‚ö†Ô∏è Secret not found, defaulting to localhost:3000 (Development Mode)"
            TARGET_URL="http://localhost:3000"
          fi
          
          RESPONSE=$(curl -X POST "$TARGET_URL/api/revalidate" \
            -H "Content-Type: application/json" \
            -H "x-revalidate-secret: ${{ secrets.REVALIDATE_SECRET }}" \
            -d '{"fragmentKey": "${{ github.event.inputs.fragment_key }}"}' \
            -s -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response Code: $HTTP_CODE"
          echo "Response Body: $BODY"
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "‚ùå Revalidation Failed!"
            exit 1
          fi
          
          echo "‚úÖ Revalidation Successful!"