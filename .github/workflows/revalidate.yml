name: Revalidate changed fragments

on:
  push:
    branches: [main]
    paths:
      - "**/fragments/**"
      - "**/fragments/*.html"
      - "docs/**"
  workflow_dispatch:
    inputs:
      fragmentKeys:
        description: "Space-separated fragment keys (e.g. home-hero pricing-card)"
        required: false
        default: ""

permissions:
  contents: read

concurrency:
  group: revalidate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  revalidate:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect fragment keys
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          # 1) workflow_dispatch로 키가 들어오면 그걸 우선 사용
          INPUT_KEYS="${{ github.event.inputs.fragmentKeys }}"
          if [[ -n "${INPUT_KEYS// /}" ]]; then
            KEYS="$(echo "$INPUT_KEYS" | tr ' ' '\n' | awk 'NF' | sort -u | head -n 20 | tr '\n' ' ')"
            echo "fragment_keys=$KEYS" >> "$GITHUB_OUTPUT"
            echo "Detected keys (manual): $KEYS"
            exit 0
          fi

          # 2) push인 경우: 변경 파일에서 fragments/*.html 키 추출
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          CHANGED="$(git diff --name-only "$BEFORE" "$AFTER" 2>/dev/null || git diff --name-only HEAD~1 HEAD || true)"
          echo "Changed files:"
          echo "$CHANGED"

          KEYS=""
          while IFS= read -r f; do
            # 어디에 있든 ".../fragments/<key>.html" 형태만 잡음
            [[ "$f" =~ /fragments/.*\.html$ ]] || [[ "$f" =~ ^fragments/.*\.html$ ]] || continue
            key="$(basename "$f" .html)"

            # API와 동일한 정규식으로 1차 검증
            if [[ "$key" =~ ^[A-Za-z0-9][A-Za-z0-9_-]{0,127}$ ]]; then
              KEYS="$KEYS $key"
            fi
          done <<< "$CHANGED"

          KEYS="$(echo "$KEYS" | tr ' ' '\n' | awk 'NF' | sort -u | head -n 20 | tr '\n' ' ')"
          echo "fragment_keys=$KEYS" >> "$GITHUB_OUTPUT"
          echo "Detected keys (auto): $KEYS"

      - name: Trigger revalidate API
        if: steps.detect.outputs.fragment_keys != ''
        env:
          REVALIDATE_URL: ${{ vars.REVALIDATE_URL }}
          REVALIDATE_SECRET: ${{ secrets.REVALIDATE_SECRET }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${REVALIDATE_URL:-}" ]]; then
            echo "Missing vars.REVALIDATE_URL"
            exit 1
          fi

          for key in ${{ steps.detect.outputs.fragment_keys }}; do
            echo "Revalidating: $key"
            curl -fS --retry 2 --retry-delay 1 -X POST "$REVALIDATE_URL" \
              -H "content-type: application/json" \
              -H "x-revalidate-secret: $REVALIDATE_SECRET" \
              -d "{\"fragmentKey\":\"$key\"}"
          done

      - name: No fragments changed
        if: steps.detect.outputs.fragment_keys == ''
        run: echo "No fragment .html changes detected. Skipping."

