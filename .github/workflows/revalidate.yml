name: Revalidate Cache

on:
  workflow_dispatch:
    inputs:
      fragment_key:
        description: 'Fragment key to revalidate (e.g., canary, system_health)'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: false
        default: 'development'
        type: choice
        options:
        - development
        - staging
        - production

jobs:
  revalidate:
    runs-on: ubuntu-latest

    environment:
      name: ${{ inputs.environment || 'development' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd packages/dashboard
          npm ci

      - name: Wait for deployment
        if: inputs.environment != 'development'
        run: |
          echo "Waiting for deployment to complete..."
          sleep 30

      - name: Revalidate cache
        run: |
          # Get dashboard URL based on environment
          if [ "${{ inputs.environment }}" = "production" ]; then
            DASHBOARD_URL="${{ secrets.DASHBOARD_URL_PRODUCTION }}"
          elif [ "${{ inputs.environment }}" = "staging" ]; then
            DASHBOARD_URL="${{ secrets.DASHBOARD_URL_STAGING }}"
          else
            DASHBOARD_URL="${{ secrets.DASHBOARD_URL_DEVELOPMENT }}"
          fi

          # Default to localhost for development if not set
          DASHBOARD_URL="${DASHBOARD_URL:-http://localhost:3000}"

          echo "Revalidating cache for fragment: ${{ inputs.fragment_key }}"
          echo "Target URL: $DASHBOARD_URL"

          # Make revalidation request
          curl -X POST "$DASHBOARD_URL/api/revalidate" \
            -H "Content-Type: application/json" \
            -H "x-revalidate-secret: ${{ secrets.REVALIDATE_SECRET }}" \
            -d "{\"fragmentKey\": \"${{ inputs.fragment_key }}\"}" \
            --fail \
            --silent \
            --show-error

      - name: Verify revalidation
        run: |
          # Get dashboard URL based on environment
          if [ "${{ inputs.environment }}" = "production" ]; then
            DASHBOARD_URL="${{ secrets.DASHBOARD_URL_PRODUCTION }}"
          elif [ "${{ inputs.environment }}" = "staging" ]; then
            DASHBOARD_URL="${{ secrets.DASHBOARD_URL_STAGING }}"
          else
            DASHBOARD_URL="${{ secrets.DASHBOARD_URL_DEVELOPMENT }}"
          fi

          DASHBOARD_URL="${DASHBOARD_URL:-http://localhost:3000}"

          echo "Verifying revalidation for fragment: ${{ inputs.fragment_key }}"

          # Check if the revalidated path returns fresh content
          # This is a basic check - in production you might want more sophisticated verification
          curl -s "$DASHBOARD_URL/fragments/${{ inputs.fragment_key }}.html" | head -n 5

  # Future: Add automated triggers
  # on:
  #   push:
  #     paths:
  #       - 'artifacts/trinity/**'
  #   workflow_call:
  #     secrets:
  #       REVALIDATE_SECRET:
  #         required: true
  #       DASHBOARD_URL_PRODUCTION:
  #         required: true