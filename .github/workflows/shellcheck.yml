name: Shellcheck Gate

on:
  pull_request:
    branches: [main]
    paths:
      - '**/*.sh'
      - 'afo'
  push:
    branches: [main]
    paths:
      - '**/*.sh'
      - 'afo'

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install Shellcheck
        run: sudo apt-get install -y shellcheck
      
      - name: Run Shellcheck
        run: |
          set -euo pipefail
          
          echo "üîç Running Shellcheck on all scripts..."
          
          # Find all shell scripts (exclude legacy infra scripts)
          SCRIPTS=$(find . -name "*.sh" -not -path "./.venv/*" -not -path "./node_modules/*" -not -name "hetzner-*.sh" -type f)
          
          # Add afo CLI
          if [[ -f ./afo ]]; then
            SCRIPTS="$SCRIPTS ./afo"
          fi
          
          FAILED=0
          for script in $SCRIPTS; do
            echo "Checking: $script"
            if shellcheck -x --severity=error "$script"; then
              echo "  ‚úÖ PASS"
            else
              echo "  ‚ùå FAIL"
              FAILED=1
            fi
          done
          
          if [[ "$FAILED" -eq 1 ]]; then
            echo ""
            echo "‚ùå Shellcheck found issues. Please fix before merging."
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All shell scripts passed Shellcheck!"
      
      - name: Alert on Failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          MESSAGE="‚ùå Shellcheck FAILED - Script quality issues detected"
          if [[ -n "${SLACK_WEBHOOK_URL:-}" ]]; then
            curl -sS -X POST -H 'Content-type: application/json' \
              --data "{\"text\": \"$MESSAGE\"}" \
              "$SLACK_WEBHOOK_URL" || true
          fi
          echo "$MESSAGE"
