name: Shellcheck Gate

on:
  pull_request:
    branches: [main]
    paths:
      - '**/*.sh'
      - 'afo'
  push:
    branches: [main]
    paths:
      - '**/*.sh'
      - 'afo'

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install Shellcheck
        run: sudo apt-get install -y shellcheck
      
      - name: Run Shellcheck
        run: |
          set -euo pipefail
          
          echo "üîç Running Shellcheck on all scripts..."
          
          # Find all shell scripts
          SCRIPTS=$(find . -name "*.sh" -not -path "./.venv/*" -not -path "./node_modules/*" -type f)
          
          # Add afo CLI
          if [[ -f ./afo ]]; then
            SCRIPTS="$SCRIPTS ./afo"
          fi
          
          FAILED=0
          for script in $SCRIPTS; do
            echo "Checking: $script"
            if shellcheck -x "$script"; then
              echo "  ‚úÖ PASS"
            else
              echo "  ‚ùå FAIL"
              FAILED=1
            fi
          done
          
          if [[ "$FAILED" -eq 1 ]]; then
            echo ""
            echo "‚ùå Shellcheck found issues. Please fix before merging."
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All shell scripts passed Shellcheck!"
