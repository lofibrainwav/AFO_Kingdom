name: SSOT Report Gate

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  ssot_report_gate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Determine diff base
        id: diffbase
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.base_ref }}"
            git fetch origin "${BASE_REF}" --depth=1
            echo "diff_base=origin/${BASE_REF}" >> "$GITHUB_OUTPUT"
          else
            echo "diff_base=HEAD~1" >> "$GITHUB_OUTPUT"
          fi

      - name: Run SSOT Report Gate on changed reports
        shell: bash
        run: |
          set -euo pipefail

          test -f scripts/ssot_report_gate.py

          DIFF_BASE="${{ steps.diffbase.outputs.diff_base }}"
          CHANGED_MD="$(git diff --name-only "${DIFF_BASE}"...HEAD | grep -E '^docs/reports/.*\.md$' || true)"

          if [ -z "${CHANGED_MD}" ]; then
            echo "No changed report markdown files. PASS."
            exit 0
          fi

          FAIL=0
          while IFS= read -r f; do
            [ -f "$f" ] || continue
            TEXT="$(cat "$f")"
            if ! python scripts/ssot_report_gate.py "$TEXT"; then
              FAIL=1
            fi
          done <<< "${CHANGED_MD}"

          exit "${FAIL}"

      - name: Detect English-heavy reports (warning only)
        id: enratio
        shell: bash
        run: |
          set -euo pipefail

          test -f scripts/detect_english_ratio.py

          DIFF_BASE="${{ steps.diffbase.outputs.diff_base }}"
          CHANGED_MD="$(git diff --name-only "${DIFF_BASE}"...HEAD | grep -E '^docs/reports/.*\.md$' || true)"

          if [ -z "${CHANGED_MD}" ]; then
            echo "json={\"flagged\":[],\"threshold\":0.5,\"count\":0}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          JSON="$(python scripts/detect_english_ratio.py ${CHANGED_MD} || true)"
          echo "json=$JSON" >> "$GITHUB_OUTPUT"
          echo "$JSON"

      - name: Comment on PR if English-heavy reports detected
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const raw = `${{ steps.enratio.outputs.json }}`.trim();
            let data = null;
            try { data = JSON.parse(raw); } catch (e) { data = { flagged: [], threshold: 0.5, count: 0 }; }

            if (!data || !data.flagged || data.flagged.length === 0) return;

            const lines = data.flagged.map(x => `- ${x.file} (english_ratio=${x.english_ratio})`).join('\n');
            const body =
              `⚠️ English-heavy report detected (threshold ≥ ${data.threshold}).\n\n` +
              `협업을 위해 한국어 비중을 조금 더 높여주세요. (영어 사용은 가능하지만, 영어-only 비율이 높으면 경고가 뜹니다.)\n\n` +
              `${lines}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
