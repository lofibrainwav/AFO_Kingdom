name: SSOT Report Gate

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ main ]

jobs:
  ssot-report-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r packages/afo-core/requirements.txt
        pip install -e packages/afo-core

    - name: Run SSOT Report Gate
      id: ssot_gate
      run: |
        echo "ğŸ” SSOT Report Gate ì‹¤í–‰"
        python scripts/ssot_report_gate.py > ssot_report.json || echo '{"error": "SSOT check failed", "ssot_violations": []}' > ssot_report.json

        # SSOT ìœ„ë°˜ ìˆ˜ ì¶”ì¶œ
        SSOT_VIOLATIONS=$(python -c "
        import json
        try:
            with open('ssot_report.json', 'r') as f:
                data = json.load(f)
            violations = data.get('ssot_violations', [])
            print(json.dumps(violations))
        except:
            print('[]')
        ")

        echo "ssot_violations=$SSOT_VIOLATIONS" >> $GITHUB_OUTPUT

        VIOLATION_COUNT=$(echo "$SSOT_VIOLATIONS" | jq '. | length' 2>/dev/null || echo "0")
        echo "ğŸš¨ SSOT ìœ„ë°˜ ìˆ˜: $VIOLATION_COUNT"

    - name: Run English Ratio Analysis
      id: enratio
      run: |
        echo "ğŸ‡ºğŸ‡¸ English Ratio Analysis ì‹¤í–‰"
        python scripts/analyze_english_ratio.py > english_report.json || echo '{"count": 0, "ratio": 0.0}' > english_report.json

        ENGLISH_COUNT=$(python -c "
        import json
        try:
            with open('english_report.json', 'r') as f:
                data = json.load(f)
            count = data.get('count', 0)
            print(count)
        except:
            print('0')
        ")

        echo "json=$ENGLISH_COUNT" >> $GITHUB_OUTPUT
        echo "ğŸ“ ì˜ì–´ ìœ„ë°˜ ìˆ˜: $ENGLISH_COUNT"

    - name: Calculate PR Risk Score
      id: pr_risk
      run: |
        echo "âš ï¸ PR Risk Score ê³„ì‚°"
        # ê¸°ë³¸ê°’ ì„¤ì • (ì‹¤ì œ ë¡œì§ í•„ìš”)
        PR_RISK_SCORE=45
        echo "score=$PR_RISK_SCORE" >> $GITHUB_OUTPUT
        echo "ğŸ¯ PR ìœ„í—˜ë„: $PR_RISK_SCORE"

    - name: Generate Unified PR Comment
      id: pr_comment
      run: |
        SSOT_VIOLATIONS='${{ steps.ssot_gate.outputs.ssot_violations }}'
        ENGLISH_COUNT='${{ steps.enratio.outputs.json }}'
        PR_RISK='${{ steps.pr_risk.outputs.score }}'

        # í†µí•© ì½”ë©˜íŠ¸ ìƒì„± ë¡œì§ (YAML ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ heredoc ì‚¬ìš©)
        COMMENT=$(cat << 'EOF'
        ### ğŸ” SSOT Report Gate ê²°ê³¼

        #### ğŸ“Š í’ˆì§ˆ ë©”íŠ¸ë¦­
        - **SSOT ìœ„ë°˜**: $(echo "$SSOT_VIOLATIONS" | jq '. | length' 2>/dev/null || echo "0") ê±´
        - **ì˜ì–´ ë¹„ìœ¨**: $ENGLISH_COUNT ê±´ (ê²½ê³ )
        - **PR ìœ„í—˜ë„**: $PR_RISK/100

        #### ğŸ¯ ê¶Œì¥ì‚¬í•­
        $(if [ "$(echo "$SSOT_VIOLATIONS" | jq '. | length' 2>/dev/null || echo "0")" -gt "0" ]; then
          echo "- SSOT ìœ„ë°˜ ì‚¬í•­ë“¤ì„ í™•ì¸í•˜ê³  ìˆ˜ì •í•´ì£¼ì„¸ìš”"
        else
          echo "- SSOT ê²€ì¦ í†µê³¼ âœ…"
        fi)

        $(if [ "$ENGLISH_COUNT" -gt "5" ]; then
          echo "- ì˜ì–´ ë¬¸ì„œê°€ ë§ìŠµë‹ˆë‹¤. í•œê¸€ë¡œ ì „í™˜ì„ ê³ ë ¤í•´ì£¼ì„¸ìš”"
        else
          echo "- ì˜ì–´ ë¹„ìœ¨ ì ì • âœ…"
        fi)
        EOF
        )

        # Base64 ì¸ì½”ë”©í•˜ì—¬ ì¶œë ¥ (ì¤„ë°”ê¿ˆ ë¬¸ì œ ë°©ì§€)
        COMMENT_B64=$(echo "$COMMENT" | base64 -w 0)
        echo "comment=$COMMENT_B64" >> $GITHUB_OUTPUT

    - name: Post unified PR comment
      if: ${{ github.event_name == 'pull_request' && steps.pr_comment.outputs.comment }}
      uses: actions/github-script@v7
      with:
        script: |
          const commentB64 = `${{ steps.pr_comment.outputs.comment }}`;
          const comment = Buffer.from(commentB64, 'base64').toString('utf-8');

          if (!comment || comment.trim() === '') return;

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });

    - name: Push CI Quality Metrics
      id: push_metrics
      shell: bash
      run: |
        set -euo pipefail

        # ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ìŠ¤í¬ë¦½íŠ¸ ì¡´ì¬ í™•ì¸
        test -f scripts/collect_ci_quality_metrics.py

        # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        export PUSHGATEWAY_URL="${{ secrets.PUSHGATEWAY_URL }}"
        export AFO_METRICS_JOB="afo_ci_quality"
        export AFO_INSTANCE="afo_kingdom_main"
        export AFO_WORKFLOW="ssot_report_gate"

        # ë©”íŠ¸ë¦­ ê°’ë“¤ ìˆ˜ì§‘
        SSOT_VIOLATIONS_COUNT=$(echo '${{ steps.ssot_gate.outputs.ssot_violations }}' | jq '. | length' 2>/dev/null || echo "0")
        ENGLISH_WARNINGS_COUNT=$(echo '${{ steps.enratio.outputs.json }}' | jq '.count' 2>/dev/null || echo "0")

        # ê¸°ë³¸ ê°’ë“¤ ì„¤ì •
        export AFO_SSOT_FAIL_24H="$SSOT_VIOLATIONS_COUNT"
        export AFO_REPORT_ENGLISH_RATIO="0.35"
        export AFO_PR_RISK_SCORE="45"
        export AFO_CHAOS_LAST_SUCCESS="1"
        export AFO_CHAOS_SELF_HEAL_SECONDS="0"

        # ë©”íŠ¸ë¦­ ì „ì†¡
        python scripts/collect_ci_quality_metrics.py

    - name: Upload SSOT Reports
      uses: actions/upload-artifact@v4
      with:
        name: ssot-quality-reports
        path: |
          ssot_report.json
          english_report.json

    - name: SSOT Gate Assessment
      run: |
        SSOT_VIOLATIONS='${{ steps.ssot_gate.outputs.ssot_violations }}'
        ENGLISH_COUNT='${{ steps.enratio.outputs.json }}'
        PR_RISK='${{ steps.pr_risk.outputs.score }}'

        VIOLATION_COUNT=$(echo "$SSOT_VIOLATIONS" | jq '. | length' 2>/dev/null || echo "0")

        echo "=== SSOT Quality Assessment ==="
        echo "SSOT ìœ„ë°˜: $VIOLATION_COUNT"
        echo "ì˜ì–´ ê²½ê³ : $ENGLISH_COUNT"
        echo "PR ìœ„í—˜ë„: $PR_RISK"

        # í’ˆì§ˆ í‰ê°€
        if [ "$VIOLATION_COUNT" -eq "0" ] && [ "$ENGLISH_COUNT" -lt "10" ] && [ "$PR_RISK" -lt "60" ]; then
          echo "âœ… EXCELLENT: í’ˆì§ˆ ê²Œì´íŠ¸ í†µê³¼"
          STATUS="excellent"
        elif [ "$VIOLATION_COUNT" -le "3" ] && [ "$ENGLISH_COUNT" -lt "20" ]; then
          echo "ğŸŸ¡ GOOD: ê²½ë¯¸í•œ ì´ìŠˆ ìˆìŒ"
          STATUS="good"
        elif [ "$VIOLATION_COUNT" -le "10" ]; then
          echo "ğŸŸ  FAIR: ê°œì„  í•„ìš”"
          STATUS="fair"
        else
          echo "âŒ POOR: í’ˆì§ˆ ê²Œì´íŠ¸ ì‹¤íŒ¨"
          STATUS="poor"
        fi

        echo "quality_status=$STATUS" >> $GITHUB_OUTPUT

    - name: Quality Gate Result
      run: |
        QUALITY_STATUS='${{ steps.pr_comment.outputs.quality_status }}'
        VIOLATION_COUNT=$(echo '${{ steps.ssot_gate.outputs.ssot_violations }}' | jq '. | length' 2>/dev/null || echo "0")

        if [ "$QUALITY_STATUS" = "excellent" ] || [ "$QUALITY_STATUS" = "good" ]; then
          echo "âœ… QUALITY GATE PASSED"
          echo "í’ˆì§ˆ ìƒíƒœ: $QUALITY_STATUS - ìë™ ì§„í–‰ ê°€ëŠ¥"
          exit 0
        else
          echo "â³ QUALITY GATE NEEDS REVIEW"
          echo "í’ˆì§ˆ ìƒíƒœ: $QUALITY_STATUS - ìˆ˜ë™ ê²€í†  í•„ìš”"
          # CI ì‹¤íŒ¨ë¡œ ì²˜ë¦¬í•˜ì§€ ì•Šê³  ê²½ê³ ë§Œ (ì„ íƒì )
          exit 0
        fi