- name: Post unified PR comment
        if: ${{ github.event_name == 'pull_request' && steps.pr_comment.outputs.comment }}
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `${{ steps.pr_comment.outputs.comment }}`;

            if (!comment || comment.trim() === '') return;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Push CI Quality Metrics
        id: push_metrics
        shell: bash
        run: |
          set -euo pipefail

          # 메트릭 수집 스크립트 존재 확인
          test -f scripts/collect_ci_quality_metrics.py

          # 환경변수 설정
          export PUSHGATEWAY_URL="${{ secrets.PUSHGATEWAY_URL }}"
          export AFO_METRICS_JOB="afo_ci_quality"
          export AFO_INSTANCE="afo_kingdom_main"
          export AFO_WORKFLOW="ssot_report_gate"

          # 메트릭 값들 수집
          SSOT_VIOLATIONS_COUNT=$(echo '${{ steps.ssot_gate.outputs.ssot_violations }}' | jq '. | length' 2>/dev/null || echo "0")
          ENGLISH_WARNINGS_COUNT=$(echo '${{ steps.enratio.outputs.json }}' | jq '.count' 2>/dev/null || echo "0")

          # 기본 값들 설정 (실제로는 계산 로직 필요)
          export AFO_SSOT_FAIL_24H="$SSOT_VIOLATIONS_COUNT"
          export AFO_REPORT_ENGLISH_RATIO="0.35"
          export AFO_PR_RISK_SCORE="45"
          export AFO_CHAOS_LAST_SUCCESS="1"
          export AFO_CHAOS_SELF_HEAL_SECONDS="0"

          # 메트릭 전송
          python scripts/collect_ci_quality_metrics.py