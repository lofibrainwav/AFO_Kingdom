name: AFO Kingdom CI/CD (uv 기반)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-and-lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]  # 왕국 Python 버전 매트릭스

    steps:
      - name: Checkout 코드
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: uv 설치 및 환경 설정
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true                # 캐싱 활성 (10x 속도)
          cache-dependency-glob: "uv.lock"  # uv.lock 변경 시 캐시 무효화
          python-version: ${{ matrix.python-version }}
          prune-cache: true                 # 오래된 캐시 정리

      - name: 의존성 설치 (재현성 보장)
        run: uv sync --frozen               # uv.lock 기반 정확 설치

      - name: Gate 1 - Pyright (Truth)
        run: |
          pyright --project packages/afo-core/pyproject.toml

      - name: Generate Evidence (Trinity Protocol)
        run: |
          mkdir -p artifacts/trinity artifacts/royal_build
          echo "Trinity Gate Passed: $(date)" > artifacts/trinity/gate_status.txt
          echo "Royal Build Verified: $(date)" > artifacts/royal_build/build_status.txt
          echo "Commit SHA: ${{ github.sha }}" >> artifacts/royal_build/build_status.txt

      - name: Ruff check (코드 품질 검증)
        run: ruff check .

      - name: Ruff format check (코드 포맷 검증)
        run: ruff format --check .

      - name: Pyright 타입 체크
        env:
          NODE_OPTIONS: "--max-old-space-size=8192"
        run: uv run pyright -p pyrightconfig.json

      - name: Pytest 테스트 (병렬 실행)
        run: uv run pytest -v -n auto

      - name: 4. SBOM & Security (永 - Eternity)
        run: make sbom

      - name: SSOT Trinity Text Guard (孝 - Serenity)
        run: python scripts/ci_trinity_text_guard.py

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./packages/afo-core/coverage.xml

      - name: AFO Import Verification (Case-Sensitive Check)
        run: |
          uv run python -c "
          import importlib.util as u
          afo_spec = u.find_spec('AFO')
          afo_lower_spec = u.find_spec('afo')
          if afo_spec is None:
              print('❌ FAIL: AFO module not found')
              exit(1)
          if afo_lower_spec is not None:
              print('❌ FAIL: afo module found (case-insensitive conflict)')
              exit(1)
          print('✅ PASS: AFO import case-sensitive verification')
          "

      - name: Upload Trinity Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trinity-evidence-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            artifacts/trinity/**
            sbom/**
          if-no-files-found: warn

      - name: Upload Royal Build Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: royal-build-evidence-${{ github.run_id }}-${{ github.run_attempt }}
          path: artifacts/royal_build/**
          if-no-files-found: warn

      - name: Push CI Quality Metrics (SSOT)
        continue-on-error: true
        env:
          PUSHGATEWAY_URL: ${{ secrets.PUSHGATEWAY_URL }}
          PUSHGATEWAY_BASIC_AUTH: ${{ secrets.PUSHGATEWAY_BASIC_AUTH }}
          AFO_WORKFLOW: ${{ github.workflow }}
          AFO_REPO: ${{ github.repository }}
        run: |
          cd packages/afo-core
          uv run python ../scripts/collect_ci_quality_metrics.py
