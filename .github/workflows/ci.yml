name: AFO Kingdom CI/CD (uv Í∏∞Î∞ò)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-and-lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]  # ÏôïÍµ≠ Python Î≤ÑÏ†Ñ (requires-python: ==3.12.*)

    steps:
      - name: Checkout ÏΩîÎìú
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: uv ÏÑ§Ïπò Î∞è ÌôòÍ≤Ω ÏÑ§Ï†ï
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true                # Ï∫êÏã± ÌôúÏÑ± (10x ÏÜçÎèÑ)
          cache-dependency-glob: "uv.lock"  # uv.lock Î≥ÄÍ≤Ω Ïãú Ï∫êÏãú Î¨¥Ìö®Ìôî
          python-version: ${{ matrix.python-version }}
          prune-cache: true                 # Ïò§ÎûòÎêú Ï∫êÏãú Ï†ïÎ¶¨

      - name: ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò (Ïû¨ÌòÑÏÑ± Î≥¥Ïû•)
        run: uv sync --frozen               # uv.lock Í∏∞Î∞ò Ï†ïÌôï ÏÑ§Ïπò

      - name: Setup Node.js (for pyright)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Gate 1 - Pyright (Truth)
        run: |
          npx pyright --project packages/afo-core/pyproject.toml

      - name: Generate Evidence (Trinity Protocol)
        run: |
          mkdir -p artifacts/trinity artifacts/royal_build
          echo "Trinity Gate Passed: $(date)" > artifacts/trinity/gate_status.txt
          echo "Royal Build Verified: $(date)" > artifacts/royal_build/build_status.txt
          echo "Commit SHA: ${{ github.sha }}" >> artifacts/royal_build/build_status.txt

      - name: Ruff check (ÌïµÏã¨ ÏòÅÏó≠ Í≤ÄÏ¶ù)
        run: uv run ruff check packages/afo-core/AFO
      - name: Ruff format check (ÌïµÏã¨ ÏòÅÏó≠ Ìè¨Îß∑ Í≤ÄÏ¶ù)
        run: uv run ruff format --check packages/afo-core/AFO

      - name: Pyright ÌÉÄÏûÖ Ï≤¥ÌÅ¨
        env:
          NODE_OPTIONS: "--max-old-space-size=8192"
        run: uv run pyright -p pyrightconfig.json

      - name: Pytest ÌÖåÏä§Ìä∏ (Î≥ëÎ†¨ Ïã§Ìñâ)
        run: uv run pytest -v -n auto

      - name: 4. SBOM & Security (Ê∞∏ - Eternity)
        run: make sbom

      - name: SSOT Trinity Text Guard (Â≠ù - Serenity)
        run: python scripts/ci_trinity_text_guard.py

      - name: SSOT Security Verification (üîí - Security)
        run: |
          echo "=== SSOT Security Verification ==="
          if [ ! -f "scripts/verify_security_cleanup.sh" ]; then
            echo "‚ùå FAIL: SSOT verification script not found"
            exit 1
          fi

          # SSOT Í≤ÄÏ¶ù Ïã§Ìñâ Î∞è Í≤∞Í≥º ÌôïÏù∏
          bash scripts/verify_security_cleanup.sh > ssot_security_output.txt 2>&1

          # EXIT_CODE ÌôïÏù∏
          if ! grep -q "EXIT_CODE=0" ssot_security_output.txt; then
            echo "‚ùå FAIL: SSOT security verification failed"
            cat ssot_security_output.txt
            exit 1
          fi

          # ÎØºÍ∞ê Îç∞Ïù¥ÌÑ∞ ÎÖ∏Ï∂ú ÌôïÏù∏ (Î≥¥Ïïà Í≤ÄÏ¶ù)
          if grep -q "secrets\|password\|token\|key" ssot_security_output.txt; then
            echo "‚ùå FAIL: Sensitive data detected in SSOT output"
            exit 1
          fi

          echo "‚úÖ PASS: SSOT security verification completed"
          echo "Evidence saved: ssot_security_output.txt"

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./packages/afo-core/coverage.xml

      - name: AFO Import Verification (Case-Sensitive Check)
        run: |
          uv run python -c "
          import importlib.util as u
          afo_spec = u.find_spec('AFO')
          afo_lower_spec = u.find_spec('afo')
          if afo_spec is None:
              print('‚ùå FAIL: AFO module not found')
              exit(1)
          if afo_lower_spec is not None:
              print('‚ùå FAIL: afo module found (case-insensitive conflict)')
              exit(1)
          print('‚úÖ PASS: AFO import case-sensitive verification')
          "

      - name: Upload Trinity Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trinity-evidence-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            artifacts/trinity/**
            sbom/**
          if-no-files-found: warn

      - name: Upload Royal Build Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: royal-build-evidence-${{ github.run_id }}-${{ github.run_attempt }}
          path: artifacts/royal_build/**
          if-no-files-found: warn

      - name: Push CI Quality Metrics (SSOT)
        continue-on-error: true
        env:
          PUSHGATEWAY_URL: ${{ secrets.PUSHGATEWAY_URL }}
          PUSHGATEWAY_BASIC_AUTH: ${{ secrets.PUSHGATEWAY_BASIC_AUTH }}
          AFO_WORKFLOW: ${{ github.workflow }}
          AFO_REPO: ${{ github.repository }}
        run: |
          cd packages/afo-core
          uv run python ../scripts/collect_ci_quality_metrics.py
