name: AFO Kingdom CI/CD (uv 기반)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-and-lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]  # 왕국 Python 버전 (requires-python: ==3.12.*)

    steps:
      - name: Checkout 코드
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Security Gate - Gitleaks Scan (Fail Loud)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          config-path: .gitleaks.toml
          fail-on-error: true

      - name: uv 설치 및 환경 설정
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true                # 캐싱 활성 (10x 속도)
          cache-dependency-glob: "uv.lock"  # uv.lock 변경 시 캐시 무효화
          python-version: ${{ matrix.python-version }}
          prune-cache: true                 # 오래된 캐시 정리

      - name: 의존성 설치 (재현성 보장)
        run: uv sync --frozen               # uv.lock 기반 정확 설치

      - name: Setup Node.js (for pyright)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate Evidence (Trinity Protocol)
        run: |
          mkdir -p artifacts/trinity artifacts/royal_build
          echo "Trinity Gate Passed: $(date)" > artifacts/trinity/gate_status.txt
          echo "Royal Build Verified: $(date)" > artifacts/royal_build/build_status.txt
          echo "Commit SHA: ${{ github.sha }}" >> artifacts/royal_build/build_status.txt

      - name: Ruff check (핵심 영역 검증)
        run: uv run ruff check packages/afo-core/AFO
      - name: Ruff format check (핵심 영역 포맷 검증)
        run: uv run ruff format --check packages/afo-core/AFO

      - name: Pyright 타입 체크
        env:
          NODE_OPTIONS: "--max-old-space-size=8192"
        run: uv run pyright -p pyrightconfig.json

      - name: Start API Server (Background)
        working-directory: packages/afo-core
        shell: bash
        run: |
          set -euo pipefail
          nohup python -m uvicorn api_server:app --host 127.0.0.1 --port 8010 > "$GITHUB_WORKSPACE/server.log" 2>&1 &
          echo $! > "$GITHUB_WORKSPACE/server.pid"
          # CI 환경에서 서버 시작 안정화 대기
          sleep 15

      - name: Check Server Startup (Debug)
        shell: bash
        run: |
          set -euo pipefail
          sleep 10  # Wait for server startup
          echo "----- Server startup log (first 20 lines) -----"
          if [ -f "$GITHUB_WORKSPACE/server.log" ]; then
            head -20 "$GITHUB_WORKSPACE/server.log"
          else
            echo "❌ Server log not found!"
          fi

      - name: Health Check (Server Ready)
        shell: bash
        run: |
          set -euo pipefail
          timeout 60 bash -c 'until curl -fsS http://127.0.0.1:8010/api/health/comprehensive >/dev/null; do sleep 1; done'
          echo "✅ API Server is ready"

      - name: Pytest 테스트 (병렬 실행)
        run: uv run pytest -v -n auto

      - name: Stop API Server
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "$GITHUB_WORKSPACE/server.pid" ]; then
            PID="$(cat "$GITHUB_WORKSPACE/server.pid")"
            kill "$PID" 2>/dev/null || true
            # 완전 봉인을 위한 하위 프로세스 정리
            pkill -P "$PID" 2>/dev/null || true
            rm -f "$GITHUB_WORKSPACE/server.pid"
          fi

      - name: Dump server log (only if failed)
        if: failure()
        shell: bash
        run: |
          echo "----- server.log -----"
          cat "$GITHUB_WORKSPACE/server.log" || true

      - name: 4. SBOM & Security (永 - Eternity)
        run: make sbom

      - name: SSOT Trinity Text Guard (孝 - Serenity)
        run: python scripts/ci_trinity_text_guard.py

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./packages/afo-core/coverage.xml

      - name: AFO Import Verification (Case-Sensitive Check)
        run: |
          uv run python -c "
          import importlib.util as u
          afo_spec = u.find_spec('AFO')
          afo_lower_spec = u.find_spec('afo')
          if afo_spec is None:
              print('❌ FAIL: AFO module not found')
              exit(1)
          if afo_lower_spec is not None:
              print('❌ FAIL: afo module found (case-insensitive conflict)')
              exit(1)
          print('✅ PASS: AFO import case-sensitive verification')
          "

      - name: Upload Trinity Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trinity-evidence-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            artifacts/trinity/**
            sbom/**
          if-no-files-found: warn

      - name: Upload Royal Build Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: royal-build-evidence-${{ github.run_id }}-${{ github.run_attempt }}
          path: artifacts/royal_build/**
          if-no-files-found: warn

      - name: Push CI Quality Metrics (SSOT)
        continue-on-error: true
        env:
          PUSHGATEWAY_URL: ${{ secrets.PUSHGATEWAY_URL }}
          PUSHGATEWAY_BASIC_AUTH: ${{ secrets.PUSHGATEWAY_BASIC_AUTH }}
          AFO_WORKFLOW: ${{ github.workflow }}
          AFO_REPO: ${{ github.repository }}
        run: |
          cd packages/afo-core
          uv run python ../scripts/collect_ci_quality_metrics.py
