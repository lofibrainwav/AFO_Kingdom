name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    defaults:
      run:
        shell: bash
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Verify tag is on origin/main
        run: |
          set -euo pipefail
          git fetch origin main --no-tags
          if ! git merge-base --is-ancestor "${GITHUB_SHA}" "origin/main"; then
            echo "‚ùå Tag must be on main branch"
            exit 1
          fi
          echo "‚úÖ Tag is on main branch"
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Trinity Gate
        run: |
          set -euo pipefail
          echo "üèõÔ∏è Running Trinity Gate..."
          if [[ -x ./afo ]]; then
            ./afo trinity
          else
            bash ./scripts/trinity_check.sh
          fi
      
      - name: Generate Evidence (Seal)
        id: seal
        run: |
          set -euo pipefail
          echo "üì¶ Generating evidence bundle..."
          if [[ -x ./afo ]]; then
            ./afo seal
          else
            bash ./scripts/ssot_seal.sh
          fi
          EVIDENCE_DIR="$(ls -dt artifacts/seal_* artifacts/ssot_* 2>/dev/null | head -n 1 || echo "")"
          if [[ -z "$EVIDENCE_DIR" ]]; then
            mkdir -p "artifacts/release_${GITHUB_REF_NAME}"
            EVIDENCE_DIR="artifacts/release_${GITHUB_REF_NAME}"
          fi
          echo "evidence_dir=$EVIDENCE_DIR" >> "$GITHUB_OUTPUT"
      
      - name: Build Release Notes
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          OUT="artifacts/release_${TAG}"
          mkdir -p "$OUT"
          NOTES="$OUT/release_notes.md"
          
          PREV="$(git tag -l 'v*' --sort=-v:refname | grep -v "^${TAG}$" | head -n 1 || true)"
          
          {
            echo "# Release ${TAG}"
            echo ""
            echo "**Commit**: \`${GITHUB_SHA}\`"
            echo "**Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo ""
            if [[ -n "$PREV" ]]; then
              echo "## Changes since ${PREV}"
              git log --no-merges --pretty=format:"- %s (\`%h\`)" "${PREV}..${GITHUB_SHA}" || true
            else
              echo "## Changes"
              git log --no-merges --pretty=format:"- %s (\`%h\`)" "${GITHUB_SHA}" -n 50 || true
            fi
          } > "$NOTES"
          
          echo "RELEASE_NOTES=$NOTES" >> "$GITHUB_ENV"
      
      - name: Create Manifest (SHA256)
        run: |
          set -euo pipefail
          EVIDENCE_DIR="${{ steps.seal.outputs.evidence_dir }}"
          python3 << 'EOF'
import hashlib, json, os, pathlib
base = os.environ.get("EVIDENCE_DIR", "artifacts")
p = pathlib.Path(base)
if not p.exists():
    p.mkdir(parents=True)
files = []
for f in sorted([x for x in p.rglob("*") if x.is_file() and x.name != "manifest.json"]):
    h = hashlib.sha256(f.read_bytes()).hexdigest()
    files.append({"path": str(f.relative_to(p)), "sha256": h, "bytes": f.stat().st_size})
out = p / "manifest.json"
out.write_text(json.dumps({"base": str(base), "files": files}, indent=2), encoding="utf-8")
print(f"Created {out} with {len(files)} files")
EOF
        env:
          EVIDENCE_DIR: ${{ steps.seal.outputs.evidence_dir }}
      
      - name: Package Evidence Zip
        run: |
          set -euo pipefail
          EVIDENCE_DIR="${{ steps.seal.outputs.evidence_dir }}"
          ZIP="artifacts/${GITHUB_REF_NAME}_evidence.zip"
          
          DIR_PARENT="$(dirname "$EVIDENCE_DIR")"
          DIR_NAME="$(basename "$EVIDENCE_DIR")"
          
          (cd "$DIR_PARENT" && zip -r "../$(basename "$ZIP")" "$DIR_NAME" >/dev/null)
          
          echo "EVIDENCE_ZIP=$ZIP" >> "$GITHUB_ENV"
      
      - name: Publish GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh release create "${GITHUB_REF_NAME}" \
            --title "Release ${GITHUB_REF_NAME}" \
            --notes-file "${RELEASE_NOTES}" \
            "${EVIDENCE_ZIP}"
          echo "‚úÖ Release ${GITHUB_REF_NAME} published!"
      
      - name: Alert on Failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          MESSAGE="‚ùå Release ${GITHUB_REF_NAME} FAILED"
          if [[ -n "${SLACK_WEBHOOK_URL:-}" ]]; then
            curl -sS -X POST -H 'Content-type: application/json' \
              --data "{\"text\": \"$MESSAGE\"}" \
              "$SLACK_WEBHOOK_URL" || true
          fi
          echo "$MESSAGE"
