name: Daily Trinity Evidence - ì² í•™ì  ì™„ì„±ë„ ë²„ì „

on:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ 00:00 UTC (LA ì‹œê°„ìœ¼ë¡œ ì „ë‚  16:00)
  workflow_dispatch:
    inputs:
      force_run:
        description: 'ê°•ì œ ì‹¤í–‰ (UTC ë‚ ì§œ ì‚¬ìš©)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  actions: write

jobs:
  philosophical-evidence-generation:
    name: "ì² í•™ì  ì¦ê±° ìƒì„± (çœå–„ç¾å­æ°¸)"
    runs-on: ubuntu-latest

    steps:
      - name: "ì™•êµ­ ì½”ë“œ ì²´í¬ì•„ì›ƒ (çœ)"
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: "ì² í•™ì  í™˜ê²½ ì„¤ì • (å–„)"
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: "ì™•êµ­ ì˜ì¡´ì„± ì„¤ì¹˜ (å­)"
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/afo-core/requirements.txt

      - name: "Trinity Evidence ìƒì„± (æ°¸)"
        id: evidence
        run: |
          echo "ğŸ° AFO ì™•êµ­ Trinity Evidence ìƒì„± ì‹œì‘"
          python scripts/generate_trinity_evidence.py

          # ê²°ê³¼ í™•ì¸
          DATE=$(date +%Y-%m-%d)
          if [ -f "artifacts/trinity/$DATE/evidence.json" ]; then
            SCORE=$(jq -r '.calculation.total' artifacts/trinity/$DATE/evidence.json)
            GATE=$(jq -r '.calculation.gate' artifacts/trinity/$DATE/evidence.json)
            echo "score=$SCORE" >> $GITHUB_OUTPUT
            echo "gate=$GATE" >> $GITHUB_OUTPUT
            echo "date=$DATE" >> $GITHUB_OUTPUT
            echo "âœ… Trinity Evidence ìƒì„± ì„±ê³µ: $SCORE ($GATE)"
          else
            echo "âŒ Trinity Evidence ìƒì„± ì‹¤íŒ¨"
            exit 1
          fi

      - name: "Evidence Index ìƒì„± (è­‰)"
        run: |
          echo "ğŸ“Š Evidence Index ìƒì„± ì‹œì‘"
          python scripts/generate_evidence_index.py
          if [ -f "artifacts/index/evidence_index.json" ]; then
            echo "âœ… Evidence Index ìƒì„± ì„±ê³µ"
          else
            echo "âŒ Evidence Index ìƒì„± ì‹¤íŒ¨"
            exit 1
          fi

      - name: "ì¦ê±° ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ç¾)"
        uses: actions/upload-artifact@v6
        with:
          name: trinity-evidence-${{ steps.evidence.outputs.date }}
          path: artifacts/trinity/${{ steps.evidence.outputs.date }}/
          retention-days: 365

      - name: "ì² í•™ì  ë³´ê³  (å–„)"
        run: |
          echo "## ğŸ° AFO ì™•êµ­ Trinity Evidence ë³´ê³ "
          echo "- **ë‚ ì§œ**: ${{ steps.evidence.outputs.date }}"
          echo "- **ì ìˆ˜**: ${{ steps.evidence.outputs.score }}"
          echo "- **íŒì •**: ${{ steps.evidence.outputs.gate }}"
          echo "- **ì² í•™**: çœå–„ç¾å­æ°¸"
          echo ""
          echo "### ğŸ“Š ì˜¤ëŠ˜ì˜ Trinity Score"
          jq '.calculation' artifacts/trinity/${{ steps.evidence.outputs.date }}/evidence.json
          echo ""
          echo "### ğŸ’­ ì² í•™ì  íŒì •"
          cat artifacts/trinity/${{ steps.evidence.outputs.date }}/verdict.md

      - name: "ìš´ì˜ ë¡œê·¸ ì—…ë¡œë“œ (å­)"
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: trinity-logs-${{ steps.evidence.outputs.date }}
          path: artifacts/logs/trinity_evidence.log
          retention-days: 30