name: Trinity Quality Gate

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ main ]

jobs:
  trinity-quality-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Configure External Services
      run: |
        echo "PUSHGATEWAY_URL=https://afo-metrics.brnestrm.com" >> $GITHUB_ENV
        echo "GRAFANA_URL=https://afo-grafana.brnestrm.com" >> $GITHUB_ENV

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r packages/afo-core/requirements.txt
        pip install -e packages/afo-core

    - name: Run Trinity Quality Assessment
      id: trinity-check
      run: |
        echo "ğŸ° AFO Kingdom - Trinity Quality Gate ì‹¤í–‰"
        python scripts/auto_lint_fix.py > trinity_report.json || echo '{"error": "Trinity check failed"}' > trinity_report.json

        # Trinity Score ì¶”ì¶œ
        TRINITY_SCORE=$(python -c "
        import json
        try:
            with open('trinity_report.json', 'r') as f:
                data = json.load(f)
            score = data.get('verification', {}).get('trinity_score', {}).get('overall_score', 0)
            print(f'{score:.1f}')
        except:
            print('0.0')
        ")

        # Auto-run ìê²© í™•ì¸
        AUTO_RUN_ELIGIBLE=$(python -c "
        import json
        try:
            with open('trinity_report.json', 'r') as f:
                data = json.load(f)
            eligible = data.get('verification', {}).get('trinity_score', {}).get('auto_run_eligible', False)
            print('true' if eligible else 'false')
        except:
            print('false')
        ")

        echo "trinity_score=$TRINITY_SCORE" >> $GITHUB_OUTPUT
        echo "auto_run_eligible=$AUTO_RUN_ELIGIBLE" >> $GITHUB_OUTPUT

        echo "ğŸ† Trinity Score: $TRINITY_SCORE/100"
        echo "ğŸš€ Auto-run Eligible: $AUTO_RUN_ELIGIBLE"

    - name: Upload Trinity Report
      uses: actions/upload-artifact@v4
      with:
        name: trinity-quality-report
        path: trinity_report.json

    - name: Trinity Score Assessment
      run: |
        TRINITY_SCORE=${{ steps.trinity-check.outputs.trinity_score }}
        AUTO_RUN_ELIGIBLE=${{ steps.trinity-check.outputs.auto_run_eligible }}

        echo "=== Trinity Quality Assessment ==="
        echo "Trinity Score: $TRINITY_SCORE/100"
        echo "Auto-run Eligible: $AUTO_RUN_ELIGIBLE"

        # Trinity Score ê¸°ë°˜ í‰ê°€
        if (( $(echo "$TRINITY_SCORE >= 90" | bc -l) )); then
          echo "âœ… EXCELLENT: Trinity Score 90+ - ìë™ ìŠ¹ì¸ ê°€ëŠ¥"
          STATUS="excellent"
        elif (( $(echo "$TRINITY_SCORE >= 80" | bc -l) )); then
          echo "ğŸŸ¡ GOOD: Trinity Score 80-89 - ìˆ˜ë™ ê²€í†  ê¶Œì¥"
          STATUS="good"
        elif (( $(echo "$TRINITY_SCORE >= 70" | bc -l) )); then
          echo "ğŸŸ  FAIR: Trinity Score 70-79 - ê°œì„  í•„ìš”"
          STATUS="fair"
        else
          echo "âŒ POOR: Trinity Score <70 - ë°˜ë ¤ ê¶Œì¥"
          STATUS="poor"
        fi

        echo "trinity_status=$STATUS" >> $GITHUB_OUTPUT

    - name: Auto-approve for Excellent Quality
      if: steps.trinity-check.outputs.auto_run_eligible == 'true' && github.event_name == 'pull_request'
      run: |
        echo "ğŸ‰ Trinity Score ìš°ìˆ˜ - ìë™ ìŠ¹ì¸ ì§„í–‰"
        # ìë™ ìŠ¹ì¸ ë¡œì§ (í•„ìš”ì‹œ êµ¬í˜„)
        # gh pr review $PR_NUMBER --approve --body "âœ… Auto-approved by Trinity Gate (Score: ${{ steps.trinity-check.outputs.trinity_score }}/100)"

    - name: Quality Gate Result
      run: |
        TRINITY_SCORE=${{ steps.trinity-check.outputs.trinity_score }}
        AUTO_RUN_ELIGIBLE=${{ steps.trinity-check.outputs.auto_run_eligible }}

        if [ "$AUTO_RUN_ELIGIBLE" = "true" ]; then
          echo "âœ… QUALITY GATE PASSED"
          echo "Trinity Score: $TRINITY_SCORE/100 - Auto-run Eligible"
          exit 0
        else
          echo "â³ QUALITY GATE NEEDS REVIEW"
          echo "Trinity Score: $TRINITY_SCORE/100 - Manual review required"
          # CI ì‹¤íŒ¨ë¡œ í‘œì‹œí•˜ì§€ ì•Šê³  ê²½ê³ ë§Œ (ì„ íƒì )
          exit 0
        fi

  # ì„ íƒì : í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (Trinity Score ê¸°ë°˜ìœ¼ë¡œ ì¡°ê±´ë¶€)
  conditional-tests:
    needs: trinity-quality-gate
    if: needs.trinity-quality-gate.outputs.auto_run_eligible == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run tests (only for excellent quality)
      run: |
        echo "ğŸ§ª Running tests for excellent quality code..."
        # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë¡œì§ (í•„ìš”ì‹œ êµ¬í˜„)
        echo "âœ… Tests completed"