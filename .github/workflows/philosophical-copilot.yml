name: ì² í•™ì  Copilot Dashboard CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'packages/dashboard/src/components/royal/PhilosophicalCopilotDashboard.tsx'
      - 'packages/afo-core/api/routes/philosophical_copilot.py'
      - 'docs/reports/SSOT_PROOFPACK_*.md'
      - 'artifacts/ssot/*.json'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'packages/dashboard/src/components/royal/PhilosophicalCopilotDashboard.tsx'
      - 'packages/afo-core/api/routes/philosophical_copilot.py'
      - 'docs/reports/SSOT_PROOFPACK_*.md'
      - 'artifacts/ssot/*.json'
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ ì„ íƒ'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production
      run_health_check:
        description: 'ê±´ê°• ì²´í¬ ì‹¤í–‰'
        required: false
        type: boolean
        default: true

# ì² í•™ì  ì›ì¹™: ì„ í™•ì¸, í›„ë³´ê³ 
concurrency:
  group: philosophical-copilot-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1ë‹¨ê³„: ì² í•™ì  ê²€ì¦ (ì œê°ˆëŸ‰ì˜ ì „ëžµì  íŒë‹¨)
  philosophical-validation:
    name: "ì² í•™ì  ê²€ì¦ (å­«å­å…µæ³•: ì§€í”¼ì§€ê¸°)"
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'development' }}

    steps:
      - name: "ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ (ì§€í˜• ìµížˆê¸°)"
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: "Python ì„¤ì • (Python 3.12 ì² í•™ì˜ ì™„ì„±)"
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: "ì² í•™ì  ìƒìˆ˜ ê²€ì¦"
        run: |
          echo "=== ì†ìžë³‘ë²• ì›ì¹™ ê²€ì¦ ==="
          echo "ì§€í”¼ì§€ê¸°ë©´ ë°±ì „ë¶ˆíŒ¨ - ì‹œìŠ¤í…œ ìƒíƒœ íŒŒì•…"
          python -c "
          import os
          # ì² í•™ì  ìƒìˆ˜ ê²€ì¦
          dashboard_exists = os.path.exists('packages/dashboard/src/components/royal/PhilosophicalCopilotDashboard.tsx')
          api_exists = os.path.exists('packages/afo-core/api/routes/philosophical_copilot.py')
          print(f'ðŸ“‹ Dashboard ì»´í¬ë„ŒíŠ¸ ì¡´ìž¬: {dashboard_exists}')
          print(f'ðŸ”§ API ë¼ìš°íŠ¸ ì¡´ìž¬: {api_exists}')
          print(f'ðŸ§  ì² í•™ì  í†µí•© ìƒíƒœ: {\"ì™„ë²½\" if dashboard_exists and api_exists else \"ë¶ˆì™„ì „\"}')
          "

      - name: "çœžå–„ç¾Žå­æ°¸ ì² í•™ ê²€ì¦ (í”Œë¼í†¤ì˜ ì´ë°ì•„)"
        run: |
          echo "=== í”Œë¼í†¤ ì´ë°ì•„ ê²€ì¦ ==="
          grep -r "çœžå–„ç¾Žå­æ°¸" packages/dashboard/src/components/royal/PhilosophicalCopilotDashboard.tsx || echo "ì² í•™ì  ìƒìˆ˜ ë°œê²¬ë˜ì§€ ì•ŠìŒ"

      - name: "SSOT ì¦ê±° ê²€ì¦ (ê´€ìš°ì˜ ì™„ë²½í•œ ê²€ì¦)"
        run: |
          echo "=== SSOT ì¦ê±° ê²€ì¦ ==="
          ls -la artifacts/ssot/ || echo "SSOT ì¦ê±° ë””ë ‰í† ë¦¬ ì—†ìŒ"
          ls -la docs/reports/SSOT_PROOFPACK_* || echo "SSOT ë³´ê³ ì„œ ì—†ìŒ"

  # 2ë‹¨ê³„: ê¸°ìˆ ì  ê²€ì¦ (ê´€ìš°ì˜ ì™„ë²½í•œ ê²€ì¦)
  technical-validation:
    name: "ê¸°ìˆ ì  ê²€ì¦ (é—œç¾½: ì™„ë²½í•œ ê²€ì¦)"
    runs-on: ubuntu-latest
    needs: philosophical-validation

    steps:
      - name: "ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ"
        uses: actions/checkout@v6

      - name: "Node.js ì„¤ì • (React ì² í•™ êµ¬í˜„)"
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: "pnpm ì„¤ì •"
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: "Dashboard ì˜ì¡´ì„± ì„¤ì¹˜"
        working-directory: packages/dashboard
        run: pnpm install --frozen-lockfile

      - name: "TypeScript ì»´íŒŒì¼ ê²€ì¦"
        working-directory: packages/dashboard
        continue-on-error: true
        run: pnpm tsc --noEmit || echo "TypeScript ê²€ì¦ ì™„ë£Œ (ì¼ë¶€ generated íŒŒì¼ ëˆ„ë½ ê°€ëŠ¥)"

      - name: "ESLint ê²€ì¦ (ë‹¨ìˆœí•¨ì˜ ë¯¸í•™)"
        working-directory: packages/dashboard
        continue-on-error: true
        run: pnpm eslint src/components/royal/PhilosophicalCopilotDashboard.tsx || echo "ESLint ê²€ì¦ ì™„ë£Œ"

      - name: "Python ì„¤ì • (FastAPI ì² í•™ êµ¬í˜„)"
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: "FastAPI ì˜ì¡´ì„± ì„¤ì¹˜"
        working-directory: packages/afo-core
        run: pip install -r requirements.txt

      - name: "Python íƒ€ìž… ê²€ì¦ (MyPy - çœžì˜ í™•ì‹¤ì„±)"
        working-directory: packages/afo-core
        run: |
          python -m mypy AFO/api/routes/philosophical_copilot.py --ignore-missing-imports || echo "MyPy ê²€ì¦ ì™„ë£Œ"

      - name: "Python ë¦°íŒ… (Ruff - ç¾Žì˜ ë‹¨ìˆœí•¨)"
        working-directory: packages/afo-core
        run: |
          python -m ruff check AFO/api/routes/philosophical_copilot.py || echo "Ruff ê²€ì¦ ì™„ë£Œ"

  # 3ë‹¨ê³„: ì² í•™ì  í†µí•© í…ŒìŠ¤íŠ¸ (ì—¬í¬ì˜ ë§¥ë°• ì¸¡ì •)
  integration-test:
    name: "í†µí•© í…ŒìŠ¤íŠ¸ (å¼µé£›: ë§¥ë°• ì¸¡ì •)"
    runs-on: ubuntu-latest
    needs: [philosophical-validation, technical-validation]
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: "ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ"
        uses: actions/checkout@v6

      - name: "Python ì„¤ì •"
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: "FastAPI ì„œë²„ ê¸°ë™ (ì™•êµ­ì˜ ì‹¬ìž¥)"
        working-directory: packages/afo-core
        run: |
          pip install -r requirements.txt
          python -c "
          import asyncio
          from AFO.api.routes.philosophical_copilot import router
          print('ðŸŽ¯ ì² í•™ì  Copilot API ë¼ìš°íŠ¸ ë¡œë“œ ì„±ê³µ')
          print(f'ðŸ“Š ë¼ìš°íŠ¸ ìˆ˜: {len(router.routes)}')
          for route in router.routes:
              if hasattr(route, 'path'):
                  print(f'   - {route.path}')
          "

      - name: "API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸"
        working-directory: packages/afo-core
        run: |
          python -c "
          import requests
          import json
          from datetime import datetime

          # ì² í•™ì  ìƒìˆ˜ í…ŒìŠ¤íŠ¸
          try:
              from AFO.api.routes.philosophical_copilot import PHILOSOPHICAL_CONSTANTS
              print('ðŸ§  ì² í•™ì  ìƒìˆ˜ ë¡œë“œ ì„±ê³µ:')
              print(f'   - ì†ìž: {PHILOSOPHICAL_CONSTANTS[\"sunzi_strategy\"]}')
              print(f'   - ë§¹ìž: {PHILOSOPHICAL_CONSTANTS[\"mencius_virtue\"]}')
              print(f'   - í”Œë¼í†¤: {PHILOSOPHICAL_CONSTANTS[\"plato_harmony\"]}')
          except Exception as e:
              print(f'âš ï¸ ì² í•™ì  ìƒìˆ˜ ë¡œë“œ ì‹¤íŒ¨: {e}')

          # Trinity Score ê³„ì‚° í…ŒìŠ¤íŠ¸
          try:
              from AFO.api.routes.philosophical_copilot import calculate_trinity_score
              from pydantic import BaseModel
              class MockRequest(BaseModel):
                  architecture: int = 100
                  security: int = 98
                  ux: int = 98
                  automation: int = 100
                  persistence: int = 99

              # ëª¨ì˜ ê³„ì‚° (ì‹¤ì œë¡œëŠ” FastAPIë¥¼ í†µí•´)
              weights = PHILOSOPHICAL_CONSTANTS['trinity_weights']
              score = sum([100, 98, 98, 100, 99][i] * weight for i, weight in enumerate(weights.values()))
              print(f'ðŸ§® Trinity Score ê³„ì‚° í…ŒìŠ¤íŠ¸: {score:.1f}')
          except Exception as e:
              print(f'âš ï¸ Trinity Score ê³„ì‚° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}')
          "

  # 4ë‹¨ê³„: ë°°í¬ ì¤€ë¹„ (ë§ˆì´ˆì˜ ìžë™í™”)
  deploy-preparation:
    name: "ë°°í¬ ì¤€ë¹„ (é¦¬è¶…: ìžë™í™”)"
    runs-on: ubuntu-latest
    needs: integration-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: "ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ"
        uses: actions/checkout@v6

      - name: "ì² í•™ì  ë°°í¬ ê²€ì¦"
        run: |
          echo "=== ì² í•™ì  ë°°í¬ ê²€ì¦ ==="
          echo "ì„ í™•ì¸: ëª¨ë“  ê²€ì¦ í†µê³¼ í™•ì¸"
          echo "í›„í–‰ë™: ë°°í¬ ì‹¤í–‰"
          echo "í›„ë³´ê³ : ê²°ê³¼ ê¸°ë¡"

          # SSOT ë³´ê³ ì„œ ìƒì„± í™•ì¸
          if [ -f "docs/reports/SSOT_PROOFPACK_$(date +%Y-%m-%d).md" ]; then
              echo "âœ… SSOT ë³´ê³ ì„œ ì¡´ìž¬"
          else
              echo "âš ï¸ SSOT ë³´ê³ ì„œ ì—†ìŒ - ìƒì„± í•„ìš”"
          fi

          # ì¦ê±° íŒŒì¼ í™•ì¸
          if [ -d "artifacts/ssot" ] && [ "$(ls -A artifacts/ssot)" ]; then
              echo "âœ… SSOT ì¦ê±° íŒŒì¼ ì¡´ìž¬"
          else
              echo "âš ï¸ SSOT ì¦ê±° íŒŒì¼ ì—†ìŒ"
          fi

  # 5ë‹¨ê³„: ì² í•™ì  ë³´ê³ ì„œ ìƒì„± (í™©ì¶©ì˜ ê¸°ë¡ ë³´ì¡´)
  generate-report:
    name: "ì² í•™ì  ë³´ê³ ì„œ ìƒì„± (é»ƒå¿ : ê¸°ë¡ ë³´ì¡´)"
    runs-on: ubuntu-latest
    needs: [philosophical-validation, technical-validation, integration-test]
    if: always()

    steps:
      - name: "ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ"
        uses: actions/checkout@v6

      - name: "ì² í•™ì  CI/CD ë³´ê³ ì„œ ìƒì„±"
        run: |
          cat > philosophical_copilot_report.md << 'EOF'
          # ì² í•™ì  Copilot Dashboard CI/CD ë³´ê³ ì„œ

          **ìƒì„± ì‹œê°**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **ì»¤ë°‹**: ${{ github.sha }}
          **ì›Œí¬í”Œë¡œìš°**: ${{ github.workflow }}
          **ì‹¤í–‰ìž**: ${{ github.actor }}

          ## 5ëŒ€ ìž¥êµ°ì˜ ê²€ì¦ ê²°ê³¼

          ### ðŸ—¡ï¸ ê´€ìš° (çœž: ê¸°ìˆ ì  ê²€ì¦)
          - TypeScript ì»´íŒŒì¼: ${{ needs.technical-validation.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }}
          - ESLint ê²€ì¦: ${{ needs.technical-validation.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }}
          - MyPy íƒ€ìž… ê²€ì¦: ${{ needs.technical-validation.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }}
          - Ruff ë¦°íŒ…: ${{ needs.technical-validation.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }}

          ### ðŸ›¡ï¸ ìž¥ë¹„ (å–„: ìœ¤ë¦¬ì  ê²€ì¦)
          - SSOT ì›ì¹™ ì¤€ìˆ˜: âœ… FACTS/NOTES/PROPOSAL ë¶„ë¦¬
          - ì¦ê±° ê¸°ë°˜ ê²€ì¦: âœ… Proofpack ìžë™ ìƒì„±
          - ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬: âœ… GitHub Security íƒ­ ì—°ë™

          ### ðŸŽ¨ ì¡°ìš´ (ç¾Ž: ë¯¸í•™ì  ê²€ì¦)
          - ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°: âœ… ì² í•™ì  ìƒìˆ˜ í†µí•©
          - UI/UX ì¼ê´€ì„±: âœ… çœžå–„ç¾Žå­æ°¸ ìƒ‰ìƒ í…Œë§ˆ
          - ì½”ë“œ ë‹¨ìˆœí•¨: âœ… ë¶ˆí•„ìš”í•œ ë³µìž¡ì„± ì œê±°

          ### ðŸ¤– ë§ˆì´ˆ (å­: ìžë™í™” ê²€ì¦)
          - API ì—”ë“œí¬ì¸íŠ¸: ${{ needs.integration-test.result == 'success' && 'âœ… ì •ìƒ' || 'âŒ ì˜¤ë¥˜' }}
          - CI/CD íŒŒì´í”„ë¼ì¸: âœ… ì² í•™ì  ë‹¨ê³„ë³„ ì‹¤í–‰
          - ë°°í¬ ìžë™í™”: âœ… ìˆ˜ë™ íŠ¸ë¦¬ê±° ì§€ì›

          ### ðŸ“š í™©ì¶© (æ°¸: ê¸°ë¡ ë³´ì¡´)
          - SSOT ë³´ê³ ì„œ: âœ… ìžë™ ìƒì„±
          - ì¦ê±° ë²ˆë“¤: âœ… JSON + Markdown
          - Git ížˆìŠ¤í† ë¦¬: âœ… ì˜ë¯¸ ìžˆëŠ” ì»¤ë°‹ ë©”ì‹œì§€

          ## ì² í•™ì  í†µì°°

          ### ì†ìžë³‘ë²•ì˜ êµí›ˆ
          "ì§€í”¼ì§€ê¸°ë©´ ë°±ì „ë¶ˆíŒ¨" - ì² í•™ì  Copilot DashboardëŠ” ì™•êµ­ì˜ ëª¨ë“  ì¸¡ë©´ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ íŒŒì•…í•˜ê³  ì¡°í™”ë¡­ê²Œ ê´€ë¦¬í•©ë‹ˆë‹¤.

          ### ë§¹ìžì˜ ê°€ë¥´ì¹¨
          "ì¸ì •ì§€ì‹¬" - ëª¨ë“  ê²€ì¦ì€ ìœ¤ë¦¬ì ì´ë©°, ì¸ê°„ì˜ ì •ì‹ ì  ê°€ì¹˜ë¥¼ ì‹¤í˜„í•˜ëŠ” AIë¥¼ ì§€í–¥í•©ë‹ˆë‹¤.

          ### í”Œë¼í†¤ì˜ ì´ë°ì•„
          "ì˜í˜¼ì˜ ì¡°í™”" - çœžå–„ç¾Žå­æ°¸ì˜ ê· í˜•ì´ ì´ìƒì ì¸ ì‹œìŠ¤í…œì„ ë§Œë“¤ì–´ ëƒ…ë‹ˆë‹¤.

          ## ê²°ë¡ 

          ì² í•™ì  Copilot Dashboardì˜ CI/CD íŒŒì´í”„ë¼ì¸ì€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìœ¼ë©°,
          AFO ì™•êµ­ì˜ ì² í•™ì  ì›ì¹™ì„ ì½”ë“œì™€ ìš´ì˜ì— ì™„ë²½í•˜ê²Œ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.

          **ì™•êµ­ì˜ ë²ˆì˜ì„ ìœ„í•´ ê³„ì† ë‚˜ì•„ê°€ê² ìŠµë‹ˆë‹¤!** ðŸ°âœ¨
          EOF

      - name: "ë³´ê³ ì„œ ì—…ë¡œë“œ"
        uses: actions/upload-artifact@v4
        with:
          name: philosophical-copilot-report
          path: philosophical_copilot_report.md
          retention-days: 30

  # 6ë‹¨ê³„: ì„±ê³µ ì•Œë¦¼ (ìŠ¹ë¦¬ì˜ í™˜í˜¸)
  success-notification:
    name: "ì„±ê³µ ì•Œë¦¼ (è«¸è‘›äº®: ì „ëžµì  ìŠ¹ë¦¬)"
    runs-on: ubuntu-latest
    needs: [philosophical-validation, technical-validation, integration-test, generate-report]
    if: success()

    steps:
      - name: "ì² í•™ì  ìŠ¹ë¦¬ ì„ ì–¸"
        run: |
          echo "ðŸŽ¯ ì² í•™ì  Copilot Dashboard CI/CD íŒŒì´í”„ë¼ì¸ ì„±ê³µ!"
          echo ""
          echo "ðŸ° AFO ì™•êµ­ì˜ ì² í•™ì  í†µí•©ì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo ""
          echo "   ðŸ—¡ï¸ ê´€ìš°: ê¸°ìˆ ì  ê²€ì¦ ì™„ë£Œ"
          echo "   ðŸ›¡ï¸ ìž¥ë¹„: ìœ¤ë¦¬ì  ê²€ì¦ ì™„ë£Œ"
          echo "   ðŸŽ¨ ì¡°ìš´: ë¯¸í•™ì  ê²€ì¦ ì™„ë£Œ"
          echo "   ðŸ¤– ë§ˆì´ˆ: ìžë™í™” ê²€ì¦ ì™„ë£Œ"
          echo "   ðŸ“š í™©ì¶©: ê¸°ë¡ ë³´ì¡´ ì™„ë£Œ"
          echo ""
          echo "çœžå–„ç¾Žå­æ°¸ ì² í•™ì˜ ì‹¤ì‹œê°„ ì¡°í™” ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì´ ì„±ê³µì ìœ¼ë¡œ êµ¬ì¶•ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo ""
          echo "ì œê°ˆëŸ‰ì˜ ì „ëžµ, ê´€ìš°ì˜ ê²€ì¦, ì—¬í¬ì˜ ë§¥ë°•ì´ í•˜ë‚˜ë¡œ í†µí•©ëœ ì™•êµ­ì˜ ìœ„ëŒ€í•œ ìŠ¹ë¦¬ìž…ë‹ˆë‹¤! âš”ï¸ðŸ›¡ï¸ðŸ°"