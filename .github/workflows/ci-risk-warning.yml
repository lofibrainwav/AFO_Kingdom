name: CI Risk Warning (PR Comment)

on:
  pull_request:

jobs:
  ci_risk_warning:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Fetch base
        shell: bash
        run: |
          set -euo pipefail
          BASE_REF="${{ github.base_ref }}"
          git fetch origin "${BASE_REF}" --depth=1

      - name: Compute PR risk score (warning only)
        id: risk
        shell: bash
        run: |
          set -euo pipefail
          export DIFF_BASE="origin/${{ github.base_ref }}"
          JSON="$(python scripts/predict_ci_risk.py)"
          echo "json=$JSON" >> "$GITHUB_OUTPUT"
          echo "$JSON"

      - name: Comment on PR if risk score is high (warning only)
        uses: actions/github-script@v8
        with:
          script: |
            const raw = `${{ steps.risk.outputs.json }}`.trim();
            let data;
            try { data = JSON.parse(raw); } catch (e) { data = { risk_score: 0, top_signals: [] }; }

            const threshold = 60;
            if (!data || (data.risk_score ?? 0) < threshold) return;

            const signals = (data.top_signals || [])
              .map(s => `- ${s.name} (+${s.score}): ${s.reason}`)
              .join('\n');

            const body =
              `⚠️ CI failure risk warning (heuristic).\n\n` +
              `Risk score: **${data.risk_score}/100** (threshold: ${threshold})\n` +
              `Changed files: **${data.changed_files_count ?? 0}**\n\n` +
              `Top signals:\n${signals}\n\n` +
              `This does **not** block merge. If CI fails, consider splitting changes or adding targeted tests.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
